{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h3 class="mb-4"><i class="bi bi-envelope"></i> 내 쪽지함</h3>

    <ul class="nav nav-tabs" id="messageTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="received-tab" data-bs-toggle="tab" data-bs-target="#received" type="button" role="tab" aria-controls="received" aria-selected="true">
                받은 쪽지 
                {% if unread_count > 0 %}
                    <span class="badge bg-danger rounded-pill">{{ unread_count }}</span>
                {% endif %}
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sent-tab" data-bs-toggle="tab" data-bs-target="#sent" type="button" role="tab" aria-controls="sent" aria-selected="false">
                보낸 쪽지 
            </button>
        </li>
    </ul>

    <div class="tab-content p-3 border border-top-0 bg-white" id="messageTabContent">
        
        <div class="tab-pane fade show active" id="received" role="tabpanel" aria-labelledby="received-tab">
            <div class="list-group list-group-flush">
                {% for msg in received_messages %}
                <a href="{% url 'accounts:message_detail' msg.pk %}" class="list-group-item list-group-item-action">
                    <div class="d-flex justify-content-between">
                        <strong>
                            {% if not msg.read_at %}
                            <span class="badge bg-danger me-1">N</span> {% endif %}
                            {{ msg.title }}
                        </strong>
                        <small class="text-muted">{{ msg.created_at|date:"Y-m-d" }}</small>
                    </div>
                    <div class="small text-muted mt-1">
                        From: 
                        {% if msg.sender.avatar %}
                        <img src="{{ msg.sender.avatar.url }}" width="20" height="20" class="rounded-circle me-1">
                        {% endif %}
                        {{ msg.sender.nickname|default:msg.sender.username }}
                    </div>
                </a>
                {% empty %}
                <p class="text-center py-4 text-muted">받은 쪽지가 없습니다.</p>
                {% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="sent" role="tabpanel" aria-labelledby="sent-tab">
             <div class="list-group list-group-flush">
                {% for msg in sent_messages %}
                <a href="{% url 'accounts:message_detail' msg.pk %}" class="list-group-item list-group-item-action">
                    <div class="d-flex justify-content-between">
                        <strong>{{ msg.title }}</strong>
                        <small class="text-muted">
                            {% if msg.read_at %}
                            <span class="text-success"><i class="bi bi-check-all"></i> 읽음</span>
                            {% else %}
                            <span class="text-secondary">읽지 않음</span>
                            {% endif %}
                        </small>
                    </div>
                    <div class="small text-muted mt-1">
                        To: 
                        {% if msg.receiver.avatar %}
                        <img src="{{ msg.receiver.avatar.url }}" width="20" height="20" class="rounded-circle me-1">
                        {% endif %}
                        {{ msg.receiver.nickname|default:msg.receiver.username }}
                    </div>
                </a>
                {% empty %}
                <p class="text-center py-4 text-muted">보낸 쪽지가 없습니다.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}